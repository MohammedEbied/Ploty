machine:

  environment:

    PLOTLY_CONFIG_DIR: ${HOME}/.plotly

dependencies:

  override:

    - pip install tox

    - tox --notest

    # install testing tools for circle's version of things
    - pip install nose coverage mock
    - pip install -I .

    # we need to cd out of the project root to ensure the install worked
    - cd ~ && python -c "import plotly"

  cache_directories:

    # cache *everything* that tox installs for us.
    - .tox

test:

  override:

    # let tox do it's thing and run all our tests.
    - tox

    # import it once normally (ensures .plotly exists)
    - python -c "import plotly"

    # test that it imports when you don't have write permissions
    - sudo chmod -R 444 ${PLOTLY_CONFIG_DIR} && python -c "import plotly"

    # test that giving back write permissions works again
    # this also has to pass the test suite that follows
    - sudo chmod -R 777 ${PLOTLY_CONFIG_DIR} && python -c "import plotly"

    # test core things in the general 2.7 version that circle has
    - nosetests -x plotly/tests/test_core --with-coverage --cover-package=plotly
    - mkdir "${CIRCLE_ARTIFACTS}/2.7" || true
    - coverage html --omit="*/tests*" -d "${CIRCLE_ARTIFACTS}/2.7" --title=2.7
